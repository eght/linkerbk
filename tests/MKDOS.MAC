;; vim: set expandtab ai textwidth=80 softtabstop=8:
;;***********************************
;; Макросы для работы с MKDOS v.3.17
;;***********************************
;; === Общие
;; При запуске программы из-под MKDOS память находится в состоянии:
;; с 40000 подключена страница 5 (первый экран),
;; с 100000 подключена страница 4, в которой находится монитор БК0010
;; и MKDOS.
;; Чтобы использовать возможности монитора 11М нужно дать ему знать
;; какие страницы куда подключены.
;; По адресу 114 хранится копия регистра управления памятью по записи.
;; Имитируем последнюю запись в регистр.
        .MACRO  AFTER$MKDOS
        mov     #16200,@#114
        .ENDM

;; Запомнить текущую страницу для подпрограмм.
        .MACRO  PUSH$JSR$PAGE
        .BWORK  #100000
        swab    R0
        bic     #177400,R0
        mov     R0,-(SP)
        .ENDM

;; Установить страниц с MKDOS (4) как рабочую для подпрограмм
        .MACRO  SET$JSR$PAGE
        .BWORK  #200+4
        .ENDM

;; Восстановить текущую страниц для подпрограмм. 
        .MACRO  POP$JSR$PAGE
        mov     (SP)+,R0
        add     #200,R0
        .BWORK  R0
        .ENDM

;; === Обращение через магнитофонный интерфейс.
;; 
        MKDOS$MAG=120002
        .MACRO  MKDOS$TAPE,TAPECMD
        mov TAPECMD,R1
        jsr PC,@#MKDOS$MAG
        .ENDM

