;; vim: set expandtab ai textwidth=80:
;;
;; Специальные значение имени сегментов:
NASEG.Dos=377          ; DOS режим
NASEG.Current=376      ; текущий режим

                ; Выход в ДОС
                .MCALL  EXIT$
SYSPAG$=2160
DOS$=120020     ; системная ячейка, содержит адрес TOP.
                ; Формат Области TOP
                ; TOP:   <код режима (DOS)> --- код исходного режима, того,
                ; в котором работает ДОС с оболочкой; изначально это Std10
                ; или Std11, т.е. стандартный режим БК10 или 11М, коды 60
                ; или 140; если программа перемещает ДОС в другой режим
                ; (например, Halt10 или Halt11), то она должна корректировать
                ; и эту ячейку
                ; TOP-2:  < old PC > --- псевдо-адрес возврата --- 100000;
                ; TOP-4:  <PS & @#6> --- здесь --- 0;
                ; TOP-6:  < @#4 > - копия ячейки 4 для ее восстановления --- 100442;
                ; TOP-10: <код текущ режима>     - при запуске и EXIT$
                ; устанавливается равным коду режима DOS, указатель WRK$ 
                ; устанавливается = TOP-10 (таким образом, WRK$ указывает
                ; на ячейку с кодом текущего режима).

                ; Переключение режима и вызов
                ; Для переключения без передачи управления:
                ; mov MODE,R0
                ; jsr R5,@#ChWrk4
                ChWrk4=<167734+4>
                .MCALL  CH$WRK

                ; Чтение или обмен слов R0
                .MCALL  RDW$N,CHW$N 

                ; Вызов подпрограммы
                .MCALL  CAL$G

                ; Чтение или обмен слова
                .MCALL  CHW$G

                ; Копирование или обмен массивов
                .MCALL  MOV$G

                ; Работа с каталогом
                .MCALL  CAT$

;; Структура записи каталога модулей
Cat.Name=0              ; Имя модуля (состоит из двух байтов:
                        ;            1 байт - идентификатор автора,
                        ;            1 байт - идентификатор модуля)
                        ; Авторы: "$" - системная
                        ;         "R" - все Reiter'ы
                        ; Лучше называть модули печатаемыми символами
Cat.Len=2               ; длина модуля в словах        
Cat.Flags=4             ; флаги модуля.
Cat.ParName=6           ; Имя родительского модуля
Cat.ExNameOff=10        ; Смещение до расширенного имени модуля (ASCIZ)
Cat.Off=12              ; Смещение от начала сегмента до модуля.
Cat.Seg=14              ; Логический номер сегмента начала модуля (один байт).
                        ; Резерв (1 байт).


;; Флаги модуля в записи каталога:
Cat.Flags.NoMove=2      ; Перемещаемость модуля (0 - да). При исчерпании памяти
                        ; модуль может быть перемещен в другое место. Если
                        ; планируется обращаться к модулю на среднем или низком
                        ; уровне нужно устанавливать в 1.
Cat.Flags.NoSplit=4     ; Разделение модуля на два подключаемых подряд сегмента
                        ; (0 - да). Максимальная длина 10000 слов.
Cat.Flags.NoDelOnExit=10  ; Удалять модуль по запросу EXIT$ или перезапуску (0 -
                          ; да)
Cat.Flags.Run=20        ; Возможность запуска модуля (1 - да, актуально для
                        ; модулей, содержащих программы). Установка этого флага
                        ; приводит к размещению по адресам от 120000 до 140000
Cat.Flags.Del=40        ; Подлежит удалению, если родительский модуль в каталоге
                        ; отсутствует. (1 - да).
Cat.Flags.RunOnDel=100  ; Перед удалением модуля запускать END-2 (по CALL)?
Cat.Flags.ExName=200    ; Есть расширенное имя модуля. 

;; Команды работы с каталогом модулей
CreateModule=0
DeleteModule=2
ReadWriteCatRecord=10
GetVersion=12                
GetLowAddrSeg=16

